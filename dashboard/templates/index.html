<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Argos Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background-color: #0f172a;
        color: #e2e8f0;
      }
      .chart-container {
        height: 600px;
        width: 100%;
      }
    </style>
  </head>
  <body class="flex flex-col h-screen">
    <!-- Header -->
    <header
      class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center"
    >
      <h1 class="text-xl font-bold flex items-center gap-2">
        游뱄 Argos Trading Bot
        <span class="text-xs bg-blue-600 px-2 py-0.5 rounded text-white"
          >v2.3</span
        >
      </h1>
      <div
        id="status-badge"
        class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-700"
      >
        Desconectado
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar Stats -->
      <aside
        class="w-64 bg-slate-800 border-r border-slate-700 p-4 flex flex-col gap-6 overflow-y-auto"
      >
        <div class="stat-card">
          <h3 class="text-slate-400 text-sm uppercase tracking-wider">
            PnL Acumulado
          </h3>
          <p id="pnl-display" class="text-2xl font-mono font-bold text-white">
            --
          </p>
        </div>

        <div class="stat-card">
          <h3 class="text-slate-400 text-sm uppercase tracking-wider">
            Posici칩n Actual
          </h3>
          <div id="position-card" class="bg-slate-700 p-3 rounded mt-1">
            <p class="text-sm">Ninguna</p>
          </div>
        </div>

        <!-- Panel de Control -->
        <div class="stat-card">
          <h3 class="text-slate-400 text-sm uppercase tracking-wider mb-2">Control</h3>
          <button onclick="reiniciar('main.py')" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-1 px-2 rounded mb-2">Reiniciar main.py</button>
          <button onclick="reiniciar('memoria.py')" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-1 px-2 rounded">Reiniciar memoria.py</button>
        </div>

        <!-- Eventos recientes -->
        <div class="stat-card">
          <h3 class="text-slate-400 text-sm uppercase tracking-wider mb-2">Eventos recientes</h3>
          <div class="flex gap-2 mb-2">
            <select id="filtro-tipo" class="bg-slate-700 text-white rounded px-2 py-1">
              <option value="">Todos</option>
              <option value="reinicio">Reinicio</option>
              <option value="reinicio_dashboard">Reinicio Dashboard</option>
              <option value="error">Error</option>
            </select>
            <input type="date" id="filtro-desde" class="bg-slate-700 text-white rounded px-2 py-1" />
            <input type="date" id="filtro-hasta" class="bg-slate-700 text-white rounded px-2 py-1" />
            <button onclick="aplicarFiltroEventos()" class="bg-blue-700 hover:bg-blue-800 text-white px-2 py-1 rounded">Filtrar</button>
          </div>
          <div class="flex gap-2 mb-2">
            <button onclick="paginaEventos(-1)" class="bg-slate-700 text-white px-2 py-1 rounded">Anterior</button>
            <span id="pagina-eventos" class="text-slate-400">1</span>
            <button onclick="paginaEventos(1)" class="bg-slate-700 text-white px-2 py-1 rounded">Siguiente</button>
          </div>
          <button onclick="exportarEventos()" class="w-full bg-green-700 hover:bg-green-800 text-white py-1 px-2 rounded mb-2">Exportar CSV</button>
          <ul id="eventos-list" class="text-xs space-y-1 max-h-40 overflow-y-auto">
            <li class="text-slate-500 italic">Cargando...</li>
          </ul>
        </div>

        <div class="mt-auto">
          <h3 class="text-slate-400 text-sm uppercase tracking-wider mb-2">
            칔ltimos Trades
          </h3>
          <ul id="trades-list" class="text-xs space-y-2">
            <li class="text-slate-500 italic">Cargando...</li>
          </ul>
        </div>

        <!-- Editor de procesos -->
        <div class="stat-card">
          <h3 class="text-slate-400 text-sm uppercase tracking-wider mb-2">Procesos monitoreados</h3>
          <ul id="procesos-list" class="text-xs space-y-1 mb-2"></ul>
          <div class="flex gap-2 mb-2">
            <input id="nuevo-nombre" type="text" placeholder="Nombre (ej: main.py)" class="bg-slate-700 text-white rounded px-2 py-1" />
            <input id="nuevo-comando" type="text" placeholder="Comando (ej: python3 main.py)" class="bg-slate-700 text-white rounded px-2 py-1" />
            <button onclick="agregarProceso()" class="bg-green-700 hover:bg-green-800 text-white px-2 py-1 rounded">Agregar</button>
          </div>
        </div>
      </aside>

      <!-- Main Chart -->
      <main class="flex-1 p-4 relative">
        <div
          id="chart"
          class="chart-container rounded-lg overflow-hidden border border-slate-700 bg-slate-900"
        ></div>
      </main>
    </div>

    <script>
      // Inicializar Gr치fico
      const chartContainer = document.getElementById("chart");
      const chart = LightweightCharts.createChart(chartContainer, {
        layout: {
          background: { type: "solid", color: "#0f172a" },
          textColor: "#cbd5e1",
        },
        grid: {
          vertLines: { color: "#1e293b" },
          horzLines: { color: "#1e293b" },
        },
        rightPriceScale: { borderColor: "#334155" },
        timeScale: {
          borderColor: "#334155",
          timeVisible: true,
          secondsVisible: false,
        },
      });

      // Serie de L칤nea (Precio)
      const lineSeries = chart.addLineSeries({
        color: "#22d3ee",
        lineWidth: 2,
      });

      async function updateData() {
        try {
          // 1. Obtener Historial
          const historyRes = await fetch("/api/history");
          const history = await historyRes.json();

          if (history.data && history.data.length > 0) {
            // Convertir time a formato lightweight charts si necesario (ya viene en timestamp s)
            const uniqueData = Array.from(
              new Map(history.data.map((item) => [item.time, item])).values(),
            );
            lineSeries.setData(uniqueData);
          }

          // 2. Obtener Stats
          const statsRes = await fetch("/api/stats");
          const stats = await statsRes.json();

          // Actualizar UI Stats
          const pnlEl = document.getElementById("pnl-display");
          pnlEl.innerText = `$${(stats.pnl_acumulado || 0).toFixed(2)}`;
          pnlEl.className = `text-2xl font-mono font-bold ${stats.pnl_acumulado >= 0 ? "text-green-400" : "text-red-400"}`;

          const posEl = document.getElementById("position-card");
          if (stats.posicion_abierta) {
            posEl.innerHTML = `
                        <div class="flex justify-between"><span class="text-green-300">COMPRA</span> <span>$${stats.precio_compra}</span></div>
                    `;
            document.getElementById("status-badge").innerText = "OPERANDO";
            document.getElementById("status-badge").className =
              "px-3 py-1 rounded-full text-sm font-semibold bg-green-600 text-white animate-pulse";
          } else {
            posEl.innerHTML = `<p class="text-slate-400 text-sm">Esperando se침al...</p>`;
            document.getElementById("status-badge").innerText = "MONITOREANDO";
            document.getElementById("status-badge").className =
              "px-3 py-1 rounded-full text-sm font-semibold bg-blue-600 text-white";
          }

          // 3. Obtener Trades
          const tradesRes = await fetch("/api/trades");
          const trades = await tradesRes.json();
          const listEl = document.getElementById("trades-list");
          listEl.innerHTML = "";

          trades.slice(0, 5).forEach((t) => {
            const li = document.createElement("li");
            const color = t.pnl_usd >= 0 ? "text-green-400" : "text-red-400";
            li.innerHTML = `
                        <div class="flex justify-between border-b border-slate-700 pb-1">
                            <span>${new Date(t.timestamp_venta).toLocaleTimeString()}</span>
                            <span class="${color} font-bold">$${t.pnl_usd.toFixed(2)}</span>
                        </div>
                    `;
            listEl.appendChild(li);
          });
        } catch (err) {
          console.error("Error fetching data:", err);
          document.getElementById("status-badge").innerText = "ERROR CONEXI칍N";
          document.getElementById("status-badge").className =
            "px-3 py-1 rounded-full text-sm font-semibold bg-red-600 text-white";
        }
      }

      // Auto-update cada 5 segundos
      updateData();
      setInterval(updateData, 5000);

      // --- Control de procesos ---
      async function reiniciar(proc) {
        if (!confirm(`쯉eguro que deseas reiniciar ${proc}?`)) return;
        try {
          const res = await fetch(`/api/restart/${proc}`, { method: 'POST' });
          const data = await res.json();
          alert(data.message || 'Acci칩n enviada');
        } catch (e) {
          alert('Error al solicitar reinicio');
        }
      }

      // --- Exportar eventos ---
      function exportarEventos() {
        window.open('/api/eventos/export', '_blank');
      }

      // --- Filtrar eventos ---
      let paginaActual = 1;
      const pageSize = 20;
      async function aplicarFiltroEventos(page = 1) {
        paginaActual = page;
        document.getElementById('pagina-eventos').innerText = paginaActual;
        const tipo = document.getElementById('filtro-tipo').value;
        const desde = document.getElementById('filtro-desde').value;
        const hasta = document.getElementById('filtro-hasta').value;
        let url = `/api/eventos/filter?page=${paginaActual}&page_size=${pageSize}`;
        if (tipo) url += `&tipo=${tipo}`;
        if (desde) url += `&desde=${desde}`;
        if (hasta) url += `&hasta=${hasta}`;
        try {
          const res = await fetch(url);
          const eventos = await res.json();
          const list = document.getElementById('eventos-list');
          list.innerHTML = '';
          if (eventos.length === 0) {
            list.innerHTML = '<li class="text-slate-500 italic">Sin eventos recientes</li>';
            return;
          }
          eventos.forEach(ev => {
            const li = document.createElement('li');
            li.innerHTML = `<span class='text-slate-400'>[${ev.timestamp.split('T')[0]}]</span> <span>${ev.evento}</span> <span class='text-slate-500'>${ev.detalle}</span>`;
            list.appendChild(li);
          });
        } catch (e) {
          document.getElementById('eventos-list').innerHTML = '<li class="text-slate-500 italic">Error al cargar eventos</li>';
        }
      }
      function paginaEventos(delta) {
        const nuevaPagina = Math.max(1, paginaActual + delta);
        aplicarFiltroEventos(nuevaPagina);
      }
      // Inicializar eventos en p치gina 1
      aplicarFiltroEventos(1);

      // --- Eventos recientes ---
      async function updateEventos() {
        try {
          const res = await fetch('/api/eventos');
          const eventos = await res.json();
          const list = document.getElementById('eventos-list');
          list.innerHTML = '';
          if (eventos.length === 0) {
            list.innerHTML = '<li class="text-slate-500 italic">Sin eventos recientes</li>';
            return;
          }
          eventos.forEach(ev => {
            const li = document.createElement('li');
            li.innerHTML = `<span class='text-slate-400'>[${ev.timestamp.split('T')[0]}]</span> <span>${ev.evento}</span> <span class='text-slate-500'>${ev.detalle}</span>`;
            list.appendChild(li);
          });
        } catch (e) {
          document.getElementById('eventos-list').innerHTML = '<li class="text-slate-500 italic">Error al cargar eventos</li>';
        }
      }
      updateEventos();
      setInterval(updateEventos, 10000);

      // --- Healthcheck de procesos ---
      async function updateHealth() {
        try {
          const res = await fetch('/api/health');
          const health = await res.json();
          const list = document.getElementById('health-list');
          list.innerHTML = '';
          health.forEach(proc => {
            const color = proc.running ? 'text-green-400' : 'text-red-400';
            const status = proc.running ? 'Activo' : 'Detenido';
            list.innerHTML += `<li><span class="${color}">${proc.name}</span>: <span class="${color}">${status}</span></li>`;
          });
        } catch (e) {
          document.getElementById('health-list').innerHTML = '<li class="text-slate-500 italic">Error al cargar estado</li>';
        }
      }
      updateHealth();
      setInterval(updateHealth, 10000);

      // Resize observer
      new ResizeObserver((entries) => {
        if (entries.length === 0 || entries[0].target !== chartContainer) {
          return;
        }
        const newRect = entries[0].contentRect;
        chart.applyOptions({ height: newRect.height, width: newRect.width });
      }).observe(chartContainer);

      // --- Procesos monitoreados ---
      let procesosActuales = [];
      async function cargarProcesos() {
        try {
          const res = await fetch('/api/procesos');
          procesosActuales = await res.json();
          renderProcesos();
        } catch (e) {
          document.getElementById('procesos-list').innerHTML = '<li class="text-slate-500 italic">Error al cargar procesos</li>';
        }
      }
      function renderProcesos() {
        const list = document.getElementById('procesos-list');
        list.innerHTML = '';
        procesosActuales.forEach((proc, idx) => {
          const li = document.createElement('li');
          li.innerHTML = `<span class='text-slate-400'>${proc.nombre}</span> <span class='text-slate-500'>${proc.comando.join(' ')}</span> <button onclick='eliminarProceso(${idx})' class='bg-red-700 text-white px-1 rounded ml-2'>Eliminar</button>`;
          list.appendChild(li);
        });
      }
      async function agregarProceso() {
        const nombre = document.getElementById('nuevo-nombre').value.trim();
        const comando = document.getElementById('nuevo-comando').value.trim();
        if (!nombre || !comando) return alert('Completa ambos campos');
        procesosActuales.push({nombre, comando: comando.split(' ')});
        await guardarProcesos();
        document.getElementById('nuevo-nombre').value = '';
        document.getElementById('nuevo-comando').value = '';
      }
      async function eliminarProceso(idx) {
        procesosActuales.splice(idx, 1);
        await guardarProcesos();
      }
      async function guardarProcesos() {
        try {
          await fetch('/api/procesos/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(procesosActuales)
          });
          cargarProcesos();
        } catch (e) {
          alert('Error al guardar procesos');
        }
      }
      cargarProcesos();
    </script>
  </body>
</html>
